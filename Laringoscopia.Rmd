---
title: "Comparación estadística entre el video-laringoscopio Pentax AWS y el laringoscopio Macintosh en pacientes con obesidad mórbida"
date: "Última actualización Agosto 2023"
author: Humberto Martínez Bautista, Ricardo A. Rodriguez Ojeda y María de Lourdes
  Delgadillo Hurtado
output:
  bookdown::html_document2:
    toc: yes
    number_sections: no
    toc_float:
      collapsed: yes
      smooth_croll: yes
      toc_depth: 2
    theme: journal
    highlight: pygments
  bookdown::pdf_document2: default
bibliography: Referencias.bib
csl: vancouver.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)

```

```{css, echo=FALSE}
.scroll-100 {
  max-height: 300px;
  overflow-y: auto;
  background-color: inherit;
}
```

# Público objetivo

<div align="justify">

El propósito de este documento es brindar apoyo a profesionales y estudiantes en el área de la salud y estadística que necesitan emplear métodos computacionales para el análisis de ensayos clínicos Se espera que los lectores cuenten con un previo conocimiento de estadística descriptiva e inferencial, así como familiaridad con conceptos de bioestadística. Aunque se presupone que los lectores tienen un nivel intermedio de vocabulario médico, el documento se esfuerza por presentar los conceptos de manera accesible.

El enfoque principal es fomentar la utilización del software estadístico libre como herramienta para llevar a cabo el análisis de ensayos clínicos. Para ello, se presentarán métodos, técnicas y ejemplos relevantes que permitan a los lectores comprender cómo aplicar estas herramientas en su trabajo. Aunque se asume cierta familiaridad con los conceptos estadísticos, se proporcionará una orientación clara y paso a paso para garantizar la comprensión y la aplicación precisa de los métodos estadísticos.
</div>

# Introducción 

<div align="justify">
La proporción de pacientes obesos y con obesidad mórbida está aumentando rápidamente en todo el mundo. Las ciencias de la salud han dicho que la intubación traqueal puede ser más difícil en estos pacientes debido al espacio reducido y la limitación orofaríngea, que provoca una visualización inadecuada.[@m]  Las intubaciones traqueales difíciles y fallidas en estos pacientes se encuentran entre las principales causas de mortalidad y morbilidad relacionadas con la anestesia.[@Tinker]

Los especialistas en el área de la salud saben que una buena visión laríngea facilita la intubación traqueal, se han introducido nuevas tecnologías para mejorar la visualización. Los videolaringoscopios suelen utilizar cámaras en miniatura para facilitar la visualización de la laringe. 

 El Pentax AWS (Figura \@ref(fig:figura1)) es un novedoso videolaringoscopio, disponible en Japón desde 2006, diseñado para facilitar la intubación proporcionando una imagen de vídeo de la glotis. Incorpora una cámara de vídeo en miniatura y un monitor LCD integrado alimentado por pilas. A una cuchilla desechable se acopla al sistema de base. La incorporación de una pantalla LCD permite ver la glotis simultáneamente a la inserción del tubo endotraqueal (ETT). En este sentido, se diferencia de otros videolaringoscopios que utilizan monitores externos. El Pentax AWS también difiere en tener un canal lateral que posiciona la guía al ETT. Los informes sugieren que este laringocopio puede ayudar a intubar, pero los datos aleatorios siguen siendo escasos.[@Ab] El método estándar para realizar laringoscopia ha sido utilizar el laringoscopio Macintosh estándar con hoja nº4 (Figura \@ref(fig:figura2)). Siendo la principal diferencia no tener una cámara de video integrada.[@Da] 
</div>

```{r figura1, echo=FALSE, out.width="20%", fig.cap="Pentax AWS", fig.align = 'center'}
knitr::include_graphics("C:/Users/bby/OneDrive/Documentos/CIMAT/EstanciasCIMAT2023/ECAs/PracticasR/Laringoscopia_R_Python/Laringoscopia_R_Pyhton/AWS_mit_Tubus.jpg")
```

```{r figura2, echo=FALSE, out.width="20%", fig.cap="Macintosh estándar con hoja nº4 ", fig.align = 'center'}
knitr::include_graphics("C:/Users/bby/OneDrive/Documentos/CIMAT/EstanciasCIMAT2023/ECAs/PracticasR/Laringoscopia_R_Python/Laringoscopia_R_Pyhton/macintosh.jpg")
```

<div align="justify">
Se realizó un estudio en pacientes con obesidad mórbida, el cual reporta sus resultados en el artículo  “A Randomized Comparison Between the Pentax AWS Video Laryngoscope and the Macintosh Laryngoscope in Morbidly Obese Patients”. En este estudio se probó la hipótesis de investigación: la intubación con Pentax AWS sería más fácil y rápida que con un laringoscopio Macintosh.

Una vez finalizado el estudio y recabada la información de los pacientes, estos fueron colocados en la base de datos "Laryngoscope" en la paquetería de medicaldata en el software estadístico computacional R, con el cual fueron obtenidos los resultados del estudio.

Este trabajo consiste en realizar una modelación estadística de los métodos utilizados en el artículo para la producción del análisis. Se manejan diferentes tipos de paquetes y funciones predefinidas en R para inferir y concluir sobre los datos. Se muestra paso a paso la aplicación de la estadística y el manejo del sowftware.
</div>

# Objetivo

<div align="justify">
Desarrollar un análisis estadístico comparando el método Pentax AWS y Macintosh en pacientes con obesidad mórbida.
</div>

## Objetivos específicos 

<div align="justify">
+ Determinar si la intubación con el Pentax AWS sería más fácil y rápida que con el Macintosh en pacientes con obesidad mórbida. 

+ Comparar los resultados obtenidos en el presente documento vs el articulo.

+ Utilizar métodos estadísticos computacionales para el desarrollo del análisis por medio de lenguaje R.
</div>

# Materiales

## Instalación y activación de librerías

<div align="justify">
Versión de RStudio: 4.2.2 

Necesitarás las siguientes liberías instaladas en tu servidor para correr el código a lo largo del documento.
</div>

```{r}
list.of.packages <- c("medicaldata", "janitor","dplyr","ggplot2","cowplot","gmodels","rstatix","psych","RColorBrewer","ggpubr","car","stats", "corrplot", "tidyverse","MVN","DescTools","broom","survival","survminer","vembedr", "kableExtra", "gtsummary", "forcats")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
```

<div align="justify">
Activación de liberías
</div>

```{r}
# Bases de datos

library(medicaldata)

# Manejo de datos

library(janitor)
library(dplyr)
library(gmodels)
library(rstatix)
library(car)
library(stats)
library(tidyverse)
library(MVN)
library(DescTools)
library(broom)
library(survival)
library(survminer)
library(forcats)

# Visualización de datos

library(ggplot2)
library(cowplot)
library(psych)
library(RColorBrewer)
library(ggpubr)
library(corrplot)
library(gtsummary)

# Embebir videos de youtube
library(vembedr)

# Manejo de tablas
library(kableExtra)

# Creación de Rmarkdown
library(rmarkdown) 
```

## Datos laringoscopia

<div align="justify">

Comenzemos viendo la base de datos, para ello necesitamos la libreria `medicaldata`, una vez instalada y activada, podemos llamar a los datos con el código debajo:
</div>

```{r}
# Base de datos

data(laryngoscope, package="medicaldata" )

# Asignación de variable a la base de datos

datos <- laryngoscope
```

### Limpieza de datos

**Renombración de variables**

<div align="justify">
ASignar un nuevo nombre a las variables ayuda a identificarlas de manera más ráída y fácil dentro del código. En este caso vamos a asignar un nuevo nombre a cada una de las variables de modo que éstas contengan un nombre en español y con una abreviación adecuada. Utilizaremos la función `rename()` donde se requiere utilizar la siguiente estructura: "nuevo nombre" = "nombre antiguo".
</div>

```{r}
datos <- rename(datos, Edad = age, Genero = gender,Estado_fisico = asa , IMC = BMI, Mallampati = Mallampati, Grupo = Randomization, Tiempo_1_intento = attempt1_time, Exito_1_intento = attempt1_S_F , Tiempo_2_intento = attempt2_time, Metodo_2_intento = attempt2_assigned_method, Exito_2_intento = attempt2_S_F, Tiempo_3_intento = attempt3_time, Metodo_3_intento = attempt3_assigned_method, Exito_3_intento = attempt3_S_F, Num_intentos = attempts,  Fracasos = failures, Tiempo_total_intubacion = total_intubation_time, Exito_intubacion = intubation_overall_S_F, Sangrado = bleeding, Nivel_dificultad = ease, Dolor_garganta = sore_throat, Vista_glotis = view)
```

**Tipos de variables**

<div align="justify">
Es importante determinar las variables tipo factores que se utilizarán en el análisis estadístico. En esta parte utilizamos la función `factor()` en la cual indicamos las variables que serán declaradas como factores, sus niveles y las etiquetas de los niveles.   
</div>


```{r}
# Factores del estudio

datos$Genero <- factor(datos$Genero, levels = c(0,1), labels = c("Femenino","Masculino"))

datos$Grupo <- factor(datos$Grupo, levels = c(0,1), labels = c("Macintosh","Pentax_AWS"))

datos$Exito_1_intento <- factor(datos$Exito_1_intento, levels = c(0,1), labels = c("No","Si"))

datos$Exito_2_intento  <- factor(datos$Exito_2_intento , levels = c(0,1), labels = c("No","Si"))

datos$Exito_3_intento <- factor(datos$Exito_3_intento, levels = c(0,1), labels = c("No","Si"))

datos$Fracasos <- factor(datos$Fracasos, levels = c(1,2,3), labels = c("1","2","3"))

datos$Exito_intubacion <- factor(datos$Exito_intubacion, levels = c(0,1), labels= c("No","Si"))

datos$Sangrado  <- factor(datos$Sangrado , levels = c(0,1), labels = c("No","Si"))

datos$Dolor_garganta  <- factor(datos$Dolor_garganta , levels = c(0,1,2,3), labels = c("Ninguno","Leve","Moderado","Severo"))

datos$Vista_glotis  <- factor(datos$Vista_glotis , levels = c(0,1), labels = c("Grado 1 o 2","Grado 3 o 4"))

datos$Estado_fisico <- factor(datos$Estado_fisico, levels = c(1,2,3,4), labels = c("I","II","III","IV"))

datos$Metodo_2_intento <- factor(datos$Metodo_2_intento, levels = c(0,1), labels = c("No","Si"))

datos$Metodo_3_intento <- factor(datos$Metodo_3_intento, levels = c(0,1), labels = c("No","Si"))
```

<div align="justify">
En el código debajo se crean dos variables auxiliares `Intentos_factor` y `Mallampati_factor`. Éstas se pueden crear con solo mencionar el nombre de la base de datos seguido de un **$** y el nombre de la nueva variable.
</div>

```{r}
# Añadir variables 

datos$Intentos_factor <- factor(datos$Num_intentos, levels = c(1,2,3))
datos$Mallampati_factor <- factor(datos$Mallampati, levels = c(1,2,3,4), labels = c("I","II", "III", "IV")) 
#%>% fct_collapse(Bueno = c("I","II"), Malo = c("III", "IV"))
```

<div align="justify">
Una vez que tenemos la base de datos con las variables arregladas, entonces utilizamos la función `attach()` para poder maneras la variables a lo largo del código sin la necesidad de utilizar métodos.
</div>

```{r}
# Adjuntar la base de datos a la sesión de trabajo

attach(datos)
```

# Métodos

<div align="justify">
El estudio fue diseñado como un ensayo clínico aleatorizado en pacientes con un índice de masa corporal entre 30 y 50 kg/m2 que requerian intubación orotraqueal para cirugía electiva.[@m] 

El procedimiento comienzó con la administración de oxígeno y la inducción de la anestesia general en los pacientes para después asignarlos al azar a la técnica de intubación, ya sea Macintosh (n = 49) o el Pentax AWS (n = 50). De 105 pacientes aleatorizados, 4 no completaron el estudio por cancelación de cirugía o porque el laringoscopista no pudo llegar al quirófano a tiempo, y 2 pacientes del grupo Pentax tuvieron resultados primarios faltantes. Por lo tanto, los datos están disponibles para los 99 pacientes que fueron analizados.

En el siguiente video se muestra una representación del procedimiento de intubación de pacientes, realizado con ambos métodos. 
</div>

```{r echo=FALSE}
library(vembedr)

embed_url("https://www.youtube.com/watch?v=3InIsTBbFRU&t=6s")%>%
  use_align("center")%>%
  use_start_time("6m22")
```

<div align="justify">
En todos los casos, la cabeza del paciente se colocó en el posición neutral sobre una almohada de espuma "donut" y el laringoscopista era libre de manipular la cabeza según fuera necesario para obtener la mejor vista posible.

La aleatorización se basó en datos generados por computadora y códigos de bloques aleatorios que fueron mantenidos dentro de sobres enumerados. 
Todas las tráqueas de los pacientes fueron intubadas por 1 de 2 anestesiólogos asistentes, cada uno de los cuales había utilizado previamente el Pentax AWS de 5 a 10 veces antes de comenzar el estudio. 
</div>

# Análisis estadístico

<div align="justify">
Se utilizaron estadísticas descriptivas estándar para comparar los grupos en las variables de referencia. Se evaluó mediante la diferencia estandarizada (es decir, la diferencia en medias o proporciones dividida por la desviación estándar combinada). Cualquier covariable con un estandarizado diferencia de 0,25 en valor absoluto se ajustó en el análisis, a menos que se especifique lo contrario.

El resultado primario fue el **tiempo total de la intubación** que se definió como el tiempo desde el inicio del primer intento de inserción del laringoscopio hasta obtener una señal del capnograma. Dentro del código se puede encontrar la variable como `Tiempo_total_intubacion`. Si un intento con el dispositivo asignado falla, entonces otro intento ó una técnica alterna se utiliza `Metodo_2_intento` y `Metodo_3_intento`. La intubación usando el método asignado dentro de los 100 segundos independientemente del número de intentos se consideró exitoso `Exito_intubacion`. 

Para los pacientes que cambiaron al otro método o cuyas tráqueas fueron intubadas en un tiempo mayor a 100 segundos, la intubación fue censurada y etiquetada como
un fracaso `Fracasos`.

La vista de la glotis para cada laringoscopia se calificó utilizando el sistema de calificación Cormack-Lehane `Vista_glotis`. La facilidad de la intubación traqueal se registró en una escala de Likert (desde 0 = extremadamente fácil a 100 = extremadamente difícil) `Nivel_dificultad`, la presencia de manchas de sangre `Sangrado` y la gravedad
de cualquier dolor de garganta postoperatorio `Dolor_garganta`.
</div>

## Análisis univariado

<div align="justify">
Para obtener un panorama general sobre la estructura de la base de datos y el tipo de cada una de las variables podemos utilizar la función `str()`.
</div>

```{r, class.output="scroll-100"}
# Estructura de los datos

str(datos)
```

<div align="justify">
Así se sabe que tenemos una base de datos con información de 99 pacientes y 24 variables, de las cuales 9 son tipo numéricas y 15 categóricas con sus respectivos niveles.

Nota: los niveles de las variables que fueron declaradas como factores serán cambiados a números en orden creciente (ej. "Ninguno" = 1, "Leve" = 2, "Moderado" = 3, "Severo" = 4).
</div>

### Normalidad univariada {.tabset .tabset-pills}

<div align="justify">
Para evaluar la normalidad de las variables cuantitativas se puede utilizar la función `mvn()` que puede aplicar varias pruebas, en este caso la prueba de **Shapiro Wilks**. 

Si el valor p es menor al nivel de significancia predefinido, se rechaza la hipótesis nula ($H_0$: Los datos se distribuyen de forma normal). 
</div>

```{r}

normalidad <- mvn(datos[,c(15,17,20)], univariateTest = "SW", desc = FALSE)
normalidad$univariateNormality
```

<div align="justify">
Ninguna de las tres variables se distribuye de forma normal. A continuación se muestra como realizar sus histogramas y añadir la curva de densidad de los datos.
</div>

**Distribuciones**

<div align="justify">
Los histogramas podemos crearlos usando la función `ggplot()`, la cual permite utilizar diferentes métodos que embellecen la visualización de los datos.
</div>

#### Tiempo total de intubacion

```{r}
# Histogramas de las variables respuesta cuantitativas

ggplot(datos, aes(x = Tiempo_total_intubacion)) +       #
       geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +
       geom_density(col=2, lwd=1) +
       facet_wrap(~ Grupo)

```

#### Número de intentos

```{r}
ggplot(datos, aes(x = Num_intentos)) + 
       geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +
       geom_density(col=2, lwd=1) +
       facet_wrap(~ Grupo)
```

#### Nivel de dificultad

```{r}
ggplot(datos, aes(x = Nivel_dificultad)) + 
       geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +
       geom_density(col=2, lwd=1) +
       facet_wrap(~ Grupo)
```

### Estadística descriptiva 

<div align="justify">
La función `tbl_summary()` calcula estadísticas descriptivas para variables continuas, categóricas y dicotómicas en R, y presenta los resultados en una tabla de resumen personalizable lista para su publicación. [@gtsummary]

En la tabla \@ref(tab:tabla1) se inspeccionan las variables basales del estudio con el propósito de evaluar la homogeneidad entre los grupos de tratamiento. Se calcula la diferencia entre Pentax y Macintosh en la media o proporción según corresponda a la variable. Se calcula también el intervalo de confianza al 95% para la diferencia estandarizada y se obtiene el valor p mediante la prueba Welch para dos muestras.
</div>

```{r tabla1}
# Evaluacion de demografía y vias respiratorias

tabla1 <- datos %>%
          
          # Selección de las variables 
  
          select("Grupo", "Edad", "Genero", "IMC", 
                 "Estado_fisico", "Mallampati") %>%
  
          # Aplicación de función tbl_summary
  
          tbl_summary(by = Grupo,                                   
                      missing = "no",                               
                      statistic = list(c("Edad", "IMC", ) ~ "{mean} ({sd})",
                                       c("Estado_fisico", "Mallampati", "Genero", "Grupo")~ "{n} ({p}%)")) %>%  
  
          # Calculo de la diferencia entre los grupos estandarizada
  
          add_difference(test = list(all_continuous() ~ "t.test",
                                     all_categorical() ~ "prop.test")) %>%
  
          # Mostrar los nombres de las etiquetas de los niveles en cursiva
  
          italicize_levels() %>%                                    
          
          # Cambio de emcabezado arriba de las columnas de los grupos
  
          modify_spanning_header(c("stat_1", "stat_2") ~ "**Tratamiento**") %>%
          
          # Cambio del encabezado de la columna de las variables 
  
          modify_header(label = "**Variable respuesta**") %>% 
  
          # Titulo de la tabla
  
          modify_caption("**Evaluacion de demografía y vias respiratorias.**") %>% 
          
          # Etiquetas de columnas y renglones en negritas
  
          bold_labels() 
  
tabla1    
```

```{r tabla2}
# Estadísticas descriptivas

tabla2 <- datos %>%
  
          select("Grupo","Tiempo_total_intubacion", "Nivel_dificultad","Exito_1_intento", 
                 "Exito_intubacion", "Num_intentos","Vista_glotis", "Mallampati_factor", "Sangrado", 
                 "Dolor_garganta") %>%
  
          tbl_summary(by = Grupo,                                   # Agrupación por tratamiento
                      missing = "no",                               # No incluir valores NA
                      statistic = list(all_categorical() ~ "{n} ({p}%)")) %>% # Calulo de las estadísticas
          
          # Cálculo de valor p
  
          add_p(test = list(all_continuous() ~ "aov",
                            all_categorical() ~ "wilcox.test")) %>%   
  
          italicize_levels() %>%                                    
          
          modify_spanning_header(c("stat_1", "stat_2") ~ "**Tratamiento**") %>%
          
          modify_header(label = "**Variable respuesta**") %>% 
  
          modify_caption("**Relación entre el tratamiento (Pentax vs Macintosh) y las variables respuesta.**") %>% 
          
          bold_labels()
  
tabla2  
```


<div align="justify">
**Prueba de suma de rangos de Wilcoxon**

Esta prueba se utiliza como una alternativa a la prueba t de Student, dado que la distribución de las variables sobre las cuales se realizarán las comparaciones no siguen una distribución normal. La prueba evalua las hipótesis:

Hipótesis nula ($H_0$): No hay diferencia significativa entre las distribuciones de las dos muestras. 

Hipótesis alternativa ($H_1$): Existe una diferencia significativa entre las distribuciones de las dos muestras. 

Si el valor p resultante es menor que el nivel de significancia predefinido (generalmente 0.05), se rechaza la hipótesis nula, lo que sugiere que hay evidencia suficiente para afirmar que existe una diferencia significativa entre las dos muestras.  

Se utilizará ésta prueba para comparar los grupos de tratamiento en las respuestas: 

mediante la función `wilcox.test()`, donde se indican los valores a comparar.

Primero crearemos dos subgrupos, uno para cada grupo de tratamiento los cuales contengas las variables sobre las cuales se realizarán las comparaciones.
</div>


## Análisis bivariado

## Pruebas de Fisher
<div align="justify">
Evaluación del efecto de tratamiento sobre las variables: éxito de intubación en el primer intento, éxito de intubación en general, sagrando y visibilidad de la glotis, mediante la prueba exacta de Fisher.

La prueba exacta de Fisher es una prueba estadística utilizada para analizar la asociación entre dos variables categóricas en una tabla de contingencia 2x2. Esta prueba calcula la probabilidad de obtener la distribución de frecuencias observadas. Si la probabilidad resultante es menor a 0.05 se rechaza la hipótesis nula y se concluye que hay evidencia suficiente para afirmar la asociación entre dos variables categóricas.[@Ro]

Hipótesis nula ($H_0$): No hay asociación entre las dos variables categóricas; es decir, la distribución de las frecuencias es independiente. 

Hipótesis alternativa ($H_1$): Existe asociación entre las dos variables categóricas. 
</div>

```{r}
# Creación de tablas de contingencia

# Tratamiento vs éxito de intubación en el primer intento

t1 <- table(datos$Grupo, datos$Exito_1_intento)

# Tratamiento vs éxito de intubación en general

t2 <- table(datos$Grupo, datos$Exito_intubacion)

# Tratamiento vs sagrando

t3 <- table(datos$Grupo, datos$Sangrado)

# Tratamiento vs visibilidad de la glotis

t4 <- table(datos$Grupo, datos$Vista_glotis)

# Tratamiento vs dolor de garganta

t5 <- table(datos$Grupo, datos$Dolor_garganta)
```

Odds ratio: measure of how far from independence the 2x2 table is
H_O: odds ratio = 0 (no asociación)
H_a: odds ratio = 1 (asociación)

```{r}
# Prueba exacta e Fisher para tratamiento vs éxito de intubación en el primer intento

fisher.test(t1)
```

Una vez realizada la prueba exacta de Fisher se tiene un valor p > $\alpha$ = 0.05, por lo cual no existe evidencia estadística suficiente para rechazar ($H_0$: No existe asociación entre las variables), es decir, que el tratamiento no tiene un efecto sobre el éxito de intubación en el primer intento.


```{r}
# Prueba exacta e Fisher para tratamiento vs éxito de intubación en general

fisher.test(t2)
```

```{r}
# Prueba exacta e Fisher para tratamiento vs sagrando

fisher.test(t3)
```

```{r}
# Prueba exacta e Fisher para tratamiento vs visibilidad de la glotis

fisher.test(t4)
```

```{r}
# Prueba exacta e Fisher para tratamiento vs dolor de garganta

fisher.test(t5)
```

```{r}
datos %>%
  select("Exito_1_intento","Exito_intubacion","Sangrado","Vista_glotis","")
  tbl_cross(
    row = stage,
    col = trt,
    percent = "cell"
  ) 
```


## Kaplan Meier

<div align="justify">
El procedimiento de Kaplan-Meier es una técnica estadística no paramétrica utilizada para estimar la función de supervivencia en estudios de supervivencia o análisis de tiempo hasta un evento. El análisis de supervivencia se enfoca en estudiar el tiempo transcurrido hasta que se produce un evento de interés en una muestra de individuos o elementos. 

procedimiento Kaplan-Meier construye una curva de supervivencia al estimar la función de supervivencia S(t) en diferentes puntos de tiempo. La curva de supervivencia muestra cómo la probabilidad de supervivencia cambia a lo largo del tiempo. Para estimar S(t), se utilizan las tasas de supervivencia en cada intervalo de tiempo basadas en el número de eventos ocurridos y la cantidad de individuos en riesgo de experimentar el evento en cada intervalo.[@Wayne]

En esta práctica se utilizará la prueba de Kaplan-Meier para estimar el éxito en el porcentaje de intubación a lo largo del tiempo. 
</div>

```{r}
# Ajusta el modelo de supervivencia para el grupo 'Macintosh'
fit_macintosh <- survfit(Surv(Tiempo_total_intubacion, Exito_intubacion) ~ Grupo, data = datos[datos$Grupo == "Macintosh",])

# Ajusta el modelo de supervivencia para el grupo 'Pentax_AWS'
fit_pentax_aws <- survfit(Surv(Tiempo_total_intubacion, Exito_intubacion) ~ Grupo, data = datos[datos$Grupo == "Pentax_AWS",])

# Grafica las curvas de supervivencia para ambos grupos
par(mfrow = c(1, 1))  # Organiza el gráfico en una sola fila

# Coloca las etiquetas del eje Y en formato de porcentajes invertidos
options(scipen=999)  # Evita la notación científica en los ejes

# Grafica la curva de supervivencia para el grupo 'Macintosh'
plot(fit_macintosh, col = "blue", lwd = 2, main = "Curvas de Supervivencia de Kaplan-Meier",
     xlab = "Tiempo total de incubación (s)", ylab = "% de exito de intubación", xlim = c(0, max(datos$Tiempo_total_intubacion)),
     ylim = c(1, 0), yaxt = "n")  # Invierte el eje Y

# Grafica la curva de supervivencia para el grupo 'Pentax_AWS'
lines(fit_pentax_aws, col = "red", lwd = 2)

# Modifica las etiquetas del eje Y para mostrar porcentajes invertidos
porcentajes_invertidos <- seq(0, 100, by = 10)
etiquetas_eje_y <- sprintf("%1.0f%%", rev(porcentajes_invertidos))
axis(2, at = rev(porcentajes_invertidos) / 100, labels = etiquetas_eje_y)

# Agrega leyendas
legend("topleft", legend = c("Macintosh", "Pentax_AWS"), col = c("blue", "red"), lwd = 2)

# Agrega etiquetas de tamaño de muestra en la parte de abajo a la derecha
muestra_macintosh <- sum(datos$Grupo == "Macintosh")
muestra_pentax_aws <- sum(datos$Grupo == "Pentax_AWS")
muestra_texto <- paste("N Macintosh=", muestra_macintosh, "  N Pentax AWS =", muestra_pentax_aws)

text(x = 40, y = 0, labels = muestra_texto, pos = 4, adj = 1)
```


```{r tablaKaplan}
# Creación de función de supervivencia

survObject <- Surv(datos$Tiempo_total_intubacion, as.numeric(datos$Exito_intubacion))

# Creación de curvas de supervivencia 

fit <- survfit(survObject ~ Grupo, data = datos)
```

De la gráfica \@ref(tab:tablaKaplan) podemos deducir que el laringoscopio Macintosh representado en color rojo es el que mejor % de éxito de intubación ofrece mientras que el laringoscopio Pentax AWS ofrece peores resutados.

¿Es la diferencia estadisticamente significativa?

```{r}
# 

logRank <- survdiff(survObject ~ datos$Grupo)

pval <- p.val <- 1 - pchisq(logRank$chisq, length(logRank$n) - 1) 

ggsurvplot(fit, data=datos, pval = round(pval,10), xlab="Tiempo", ylab="Exito de intubacion %", conf.int = T) 

```


### Intervalos de confianza a 95% para la proporción de éxito de intubación en el primero intento y éxito de intubación en general

```{r}
# Extracción de columna de éxito de intubación en el primer intento por grupo

# Éxito de intubación en el primer intento en grupo Macintosh

Exito_1int_Macintosh <- datos %>%
                  filter(datos$Grupo == "Macintosh") %>%
                  select(Exito_1_intento)

# Éxito de intubación en el primer intento en grupo Pentax_AWS

Exito_1int_Pentax_AWS <- datos %>%
               filter(datos$Grupo == "Pentax_AWS") %>%
               select(Exito_1_intento)

```


```{r}
# Conteo de éxito de intubación en el primer intento para cada grupo

# Conteo en grupo Macintosh

Exito_1int_Macintosh %>%  
  tabyl(Exito_1_intento) %>% 
  adorn_totals("row")

# Conteo en grupo Pentax_AWS

Exito_1int_Pentax_AWS %>%  
  tabyl(Exito_1_intento) %>% 
  adorn_totals("row")
```

```{r}
# Intervalos de confianza a 95% para el éxito de intubación en el primer intento 
# Metodo Wilson (default)

# Intervalo de confianza a 95% para el éxito de intubación en el primer intento para grupo Macintosh

BinomCI(45,49,conf.level=0.95)

# Intervalo de confianza a 95% para el éxito de intubación en el primer intento para grupo Pentax_AWS

BinomCI(43,50,conf.level=0.95)
```


```{r}
# Extracción de columna de éxito de intubación en general por grupo

# Éxito de intubación en general en grupo Macintosh

Exito_gen_Macintosh <- datos %>%
                  filter(datos$Grupo == "Macintosh") %>%
                  select(Exito_intubacion)

# Éxito de intubación en general en grupo Pentax_AWS

Exito_gen_Pentax_AWS <- datos %>%
               filter(Grupo == "Pentax_AWS") %>%
               select(Exito_intubacion)

```


```{r}
# Conteo de éxito de intubación en general para cada grupo

# Conteo en grupo Macintosh

Exito_gen_Macintosh %>%  
  tabyl(Exito_intubacion) %>% 
  adorn_totals("row")

# Conteo en grupo Pentax_AWS

Exito_gen_Pentax_AWS %>% 
  tabyl(Exito_intubacion) %>% 
  adorn_totals("row")

```

```{r}
# Intervalos de confianza a 95% para el éxito de intubación en general

# Intervalo de confianza a 95% para el éxito de intubación en general para grupo Macintosh

BinomCI(49,49,conf.level=0.95)

# Intervalo de confianza a 95% para el éxito de intubación en general para grupo Pentax_AWS

BinomCI(46,50,conf.level=0.95)

# 45 (resultado en el articulo)
```

# Resultados



# Conclusión



# Diccionario

```{r echo=FALSE}
# Creación de columnas de la tabla

vector1 <- c("Edad","Genero","Estado_fisico","IMC","Mallampati","Grupo","Tiempo_1_intento", "Exito_1_intento", "Tiempo_2_intento", "Metodo_2_intento", "Exito_2_intento", "Tiempo_3_intento", "Metodo_3_intento", "Exito_3_intento", "Num_intentos", "Fracasos", "Tiempo_total_intubacion","Exito_intubacion", "Sangrado", "Nivel_dificultad", "Dolor_garganta", "Vista_glotis")

vector2 <- c("Edad","Genero","Estado físico, asignado por la Sociedad Americana de Anestesiólogos","Indice de masa corporal","Escala para predecir la dificultad de intubación traqueal", "A que grupo pertenece el paciente", "Tiempo de intubacion en el primer intento", "Intubación exitosa en el primer intento", "Tiempo de intubacion en el segundo intento", "Segundo intento realizado con el laringoscopio asignado 	", "Exito en el segundo intento", "Tiempo de intubacion en el tercer intento", "Tercer intento realizado con el laringoscopio asignado", "Exito en el tercer intento", "Numero de intentos realizados", "Numero de fracasos", "Tiempo total de intubacion", "Intubacion exitosa", "Presencia de sangrado", "Dificultad en la intubación traqueal", "Severidad en el dolor de garganta", "Visibilidad de la glotis en escala Cormack-lehane")

vector3 <- c("Años"," ", " ", "kg/m2", " ", " ", "Segundos", " ", "Segundos", " ", " ", "Segundos", " ", " ", "Numero de intentos al operar", "Numero de intentos al operar", " ", " "," ", " ", " ", " ")

vector4 <- c(" ", "Femenino,Masculino", "I= Un paciente sano normal; II = Un paciente con enfermedad sistémica leve; III = Un paciente con enfermedad sistémica grave; IV = Un paciente con enfermedad sistémica grave que es una amenaza constante para la vida", " "," ", " I = Las amígdalas, la úvula y el paladar blando del paciente son completamente visibles, II = El paladar duro y blando, las amígdalas superiores y la úvula son visibles, III = El paladar duro y blando son visibles, la úvula está algo oscurecida, IV = Solo el paladar duro es visible", "Pentax AWS. Macintosh hoja #4", " ", "Si, No", " ", " Si, No", "Si, No", " ", "Si, No", "Si, No", " ", " ", " ", "Si, No", "Si, No", "0 = extremadamente facil, 100 = extremadamente dificil", " ", "Grado 1 o 2, Grado 3 o 4")

# Adherencia de vectores

data <- cbind(vector1, vector2, vector3, vector4)

# Matriz

data <- as.matrix(data)
 
# Especificar nombre de las columnas
colnames(data) = c("Variable","Etiqueta","Unidad","Codificacion")

# Asignación de tabla
final=as.table(data)
 

kbl(final) %>%
  kable_styling(bootstrap_options = "striped")
```

# Cítanos

Entrada de BibTeX para usarios de Latex:

@Article{bioestadis_R,
    author = {Humberto Martínez Bautista and Ricardo A. Rodriguez Ojeda and María de Lourdes
  Delgadillo Hurtado},
    title = {Comparación estadística entre el video-laringoscopio Pentax AWS y el laringoscopio Macintosh en pacientes con obesidad mórbida},
    year = {2023},
    url = {https://doi.org/10.32614/RJ-2021-053},
    doi = {10.32614/RJ-2021-053},
    volume = {13},
    issue = {1},
    pages = {570-580},
  }

# Referencias


